name: CI/CD Testing Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18, 20]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ” Lint code
      run: npm run lint

    - name: ğŸ—ï¸ Check Svelte
      run: npm run check

    - name: ğŸ§ª Run unit tests
      run: npm test

    - name: ğŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-node-${{ matrix.node-version }}
        path: |
          coverage/
          test-results.xml
        retention-days: 7

    - name: ğŸ“ˆ Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      if: matrix.node-version == 18
      with:
        file: ./coverage/lcov.info
        fail_ci_if_error: true

  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ—ï¸ Build application
      run: npm run build

    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: build/
        retention-days: 7

  integration-test:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: build/

    - name: ğŸ”— Run integration tests
      run: npm run test:integration

    - name: ğŸ“Š Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: test-results/
        retention-days: 7

  e2e-test:
    name: ğŸ­ End-to-End Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ­ Install Playwright browsers
      run: npx playwright install --with-deps

    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: build/

    - name: ğŸ­ Run E2E tests
      run: npm run test:e2e

    - name: ğŸ“Š Upload E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results
        path: |
          test-results/
          playwright-report/
        retention-days: 7

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ”’ Run security audit
      run: npm audit --audit-level=high

    - name: ğŸ” Run dependency check
      run: npx audit-ci --high

  docker-build:
    name: ğŸ³ Docker Build & Test
    runs-on: ubuntu-latest
    needs: [test, build]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ—ï¸ Build Docker image
      run: docker build -t cicd-testing-pipeline-svelte .

    - name: ğŸ§ª Test Docker image
      run: |
        docker run --rm cicd-testing-pipeline-svelte npm test
        docker run --rm cicd-testing-pipeline-svelte npm run build

    - name: ğŸ“Š Docker image scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'cicd-testing-pipeline-svelte'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ğŸ“¤ Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  quality-gate:
    name: âœ… Quality Gate
    runs-on: ubuntu-latest
    needs: [test, integration-test, e2e-test, security-scan, docker-build]
    if: always()

    steps:
    - name: âœ… Check quality gate
      run: |
        if [[ "${{ needs.test.result }}" == "success" && 
              "${{ needs.integration-test.result }}" == "success" && 
              "${{ needs.e2e-test.result }}" == "success" && 
              "${{ needs.security-scan.result }}" == "success" && 
              "${{ needs.docker-build.result }}" == "success" ]]; then
          echo "âœ… All quality checks passed!"
          exit 0
        else
          echo "âŒ Quality gate failed!"
          echo "Test result: ${{ needs.test.result }}"
          echo "Integration test result: ${{ needs.integration-test.result }}"
          echo "E2E test result: ${{ needs.e2e-test.result }}"
          echo "Security scan result: ${{ needs.security-scan.result }}"
          echo "Docker build result: ${{ needs.docker-build.result }}"
          exit 1
        fi

  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: quality-gate
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: staging

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: build/

    - name: ğŸš€ Deploy to staging
      run: |
        echo "ğŸš€ Deploying to staging environment..."
        echo "ğŸ“ Build files ready for deployment"
        # Add your staging deployment commands here
        # For example: rsync, scp, or cloud deployment CLI

    - name: ğŸ§ª Run staging smoke tests
      run: |
        echo "ğŸ§ª Running staging smoke tests..."
        # Add smoke tests for staging environment
        # curl checks, basic functionality tests, etc.

  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: quality-gate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: build/

    - name: ğŸš€ Deploy to production
      run: |
        echo "ğŸš€ Deploying to production environment..."
        echo "ğŸ“ Build files ready for deployment"
        # Add your production deployment commands here

    - name: ğŸ§ª Run production smoke tests
      run: |
        echo "ğŸ§ª Running production smoke tests..."
        # Add smoke tests for production environment

    - name: ğŸ“¢ Notify deployment success
      run: |
        echo "ğŸ“¢ Production deployment successful!"
        # Add notification logic (Slack, email, etc.)

  notify:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [quality-gate, deploy-staging, deploy-production]
    if: always()

    steps:
    - name: ğŸ“¢ Notify on success
      if: needs.quality-gate.result == 'success'
      run: |
        echo "âœ… CI/CD Pipeline completed successfully!"
        echo "ğŸ‰ All tests passed and quality gates met"

    - name: ğŸ“¢ Notify on failure
      if: needs.quality-gate.result == 'failure'
      run: |
        echo "âŒ CI/CD Pipeline failed!"
        echo "ğŸ” Check the logs for more details"